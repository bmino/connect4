<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Connect 4</title>
    <link rel="stylesheet" href="style/canvas.css">
</head>
<body>
    <!-- Canvas -->
    <canvas id="master-canvas" width="600" height="600"></canvas>



    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/bmDraw.js"></script>
    <script type="text/javascript">
        var canvas, ctx;

        /* Connect to socket.io */
        var socket = io();

        var gameState = {
            status: 'CONNECTING',
            myTurn: false
        };

        socket.on('game:begin', function() {
            setupBoard();
            gameState.status = 'STARTING_GAME';
        });

        socket.on('game:turn', function(myTurn) {
            gameState.myTurn = myTurn;
            gameState.status = myTurn ? 'WAITING_FOR_MOVE' : 'WAITING_FOR_OPPONENT';
            console.log(gameState.status);
        });

        socket.on('game:host', function(game) {
            console.log('created new game id ' + game.id);
            gameState.id = game.id;
            gameState.status = 'SEARCHING_FOR_OPPONENT';
        });

        socket.on('game:join', function(game) {
            console.log('joined existing game id ' + game.id);
            gameState.id = game.id;
            gameState.status = 'JOINED_EXISTING_GAME';
        });

        socket.on('game:forfeit', function() {
            console.log('Congrats! Your opponent left, therefore you win!');
            gameState.status = 'WINNER';
        });


        function setupBoard() {
            console.log('Setting up board');

            canvas = document.getElementById('master-canvas');
            ctx = canvas.getContext('2d');

            /* Draws Board Grid */
            bmDraw.init(canvas, ctx, 3);

            socket.on('move:draw', function(move) {
                bmDraw.mark(move.col, move.row);
            });

            canvas.addEventListener('click', canvasClick, false);
            function canvasClick(event) {
                if (!gameState.myTurn) return;
                var x = event.pageX - canvas.offsetLeft;
                var y = event.pageY - canvas.offsetTop;
                var pos = bmDraw.identifyGridFromMouse(x, y);
                socket.emit('move:make', {
                    game: gameState.id,
                    col: pos.x,
                    row: pos.y
                });
            }
        }

    </script>
</body>
</html>