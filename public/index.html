<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tic Tac Toe</title>
    <link rel="stylesheet" href="style/canvas.css">
</head>
<body>
    <!-- Status -->
    <div id="game-status"></div>

    <!-- Canvas -->
    <canvas id="master-canvas" width="600" height="600"></canvas>



    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/bmDraw.js"></script>
    <script type="text/javascript">
        var canvas, ctx;

        /* Connect to socket.io */
        var socket = io();

        var gameState = {
            status: '',
            myTurn: false
        };
        changeStatus('CONNECTING');

        socket.on('game:begin', function() {
            setupBoard();
            changeStatus('STARTING_GAME');
        });

        socket.on('game:turn', function(myTurn) {
            gameState.myTurn = myTurn;
            changeStatus(myTurn ? 'YOUR_TURN' : 'OPPONENT_TURN');
        });

        socket.on('game:host', function(game) {
            console.log('created new game id ' + game.id);
            gameState.id = game.id;
            changeStatus('SEARCHING_FOR_OPPONENT');
        });

        socket.on('game:join', function(game) {
            console.log('joined existing game id ' + game.id);
            gameState.id = game.id;
            changeStatus('JOINED_EXISTING_GAME');
        });

        socket.on('game:forfeit', function() {
            console.log('Congrats! Your opponent left, therefore you win!');
            changeStatus('WINNER');
        });


        function setupBoard() {
            console.log('Setting up board');

            canvas = document.getElementById('master-canvas');
            ctx = canvas.getContext('2d');

            /* Draws Board Grid */
            bmDraw.init(canvas, ctx, 3);

            socket.on('move:draw:native', function(move) {
                bmDraw.mark(move.col, move.row, '#0000EE');
            });
            socket.on('move:draw:foreign', function(move) {
                bmDraw.mark(move.col, move.row, '#EE0000');
            });

            canvas.addEventListener('click', canvasClick, false);
            function canvasClick(event) {
                if (!gameState.myTurn) return;
                var x = event.pageX - canvas.offsetLeft;
                var y = event.pageY - canvas.offsetTop;
                var pos = bmDraw.identifyGridFromMouse(x, y);
                socket.emit('move:make', {
                    game: gameState.id,
                    col: pos.x,
                    row: pos.y
                });
            }
        }

        function changeStatus(status) {
            gameState.status = status;
            document.getElementById('game-status').innerText = status;
        }

    </script>
</body>
</html>